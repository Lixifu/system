## 问题分析

### 1. 根本原因

通过对代码的详细分析，我发现了导致签到签退功能异常的根本原因：

- **模拟扫描逻辑问题**：前端使用了 `simulateQRCodeScan()` 函数来模拟二维码扫描，该函数每100帧（随机概率）就会自动生成一个模拟的二维码内容，无需实际二维码存在
- **自动触发API请求**：模拟扫描生成的二维码内容会直接调用 `handleScanResult()` 函数，发起 `/api/user/sign` 请求
- **固定活动ID**：模拟扫描使用固定活动ID 1，并随机选择signIn或signOut操作
- **缺少状态控制**：没有机制确保只有在真实检测到二维码时才发起API请求
- **错误提示过早**：当模拟生成的是signOut操作，且活动1已经被签退过时，API返回400错误"您已签退"，导致错误提示过早出现

### 2. 问题流程

1. 用户打开扫码模态框
2. 点击"开始扫描"按钮
3. `startScan()` 函数被调用，设置 `scanning = true`，开始 `tick()` 循环
4. `tick()` 函数每帧调用 `simulateQRCodeScan()`
5. `simulateQRCodeScan()` 随机生成二维码内容，调用 `handleScanResult()`
6. `handleScanResult()` 发起 `/api/user/sign` 请求
7. 由于活动1已经被签退，API返回400错误"您已签退"
8. 前端显示错误提示，尽管用户还没有展示真实二维码

## 解决方案

### 1. 修复模拟扫描逻辑

- 移除自动生成模拟二维码的逻辑，确保只有在检测到真实二维码时才发起API请求
- 或者将模拟扫描功能改为手动触发，而非自动

### 2. 优化状态管理

- 添加状态控制，确保只有在真实检测到二维码时才调用API
- 优化 `handleScanResult()` 函数，添加更完善的状态检查
- 确保错误提示只在真实扫码操作后显示

### 3. 改进错误处理

- 区分真实扫码错误和模拟错误
- 添加更清晰的错误提示，避免误导用户

## 修复步骤

### 步骤1：修改模拟扫描逻辑

1. 打开 `src/js/main.js` 文件
2. 修改 `simulateQRCodeScan()` 函数，移除自动生成二维码的逻辑
3. 或者添加一个开关，只有在特定条件下才生成模拟二维码

### 步骤2：优化状态管理

1. 添加状态变量，记录是否检测到真实二维码
2. 在 `handleScanResult()` 函数中添加状态检查
3. 确保只有在真实检测到二维码时才发起API请求

### 步骤3：改进错误处理

1. 优化 `handleScanResult()` 函数的错误处理逻辑
2. 添加更清晰的错误提示，区分不同类型的错误
3. 确保错误提示只在真实扫码操作后显示

## 预期效果

修复后，签到签退功能应该：
1. 只有在真实检测到二维码时才发起API请求
2. 不再自动生成模拟二维码和发起请求
3. 错误提示只在真实扫码操作后显示
4. 用户可以正常展示二维码进行签到/签退
5. 各种场景下（连续操作、网络延迟等）均能正常工作

## 验证方法

1. 打开志愿者页面，点击"扫码签到/签退"按钮
2. 点击"开始扫描"按钮，观察是否自动显示错误提示
3. 展示真实二维码，验证是否能正常进行签到/签退
4. 连续多次操作，验证功能稳定性
5. 模拟网络延迟，验证错误处理机制