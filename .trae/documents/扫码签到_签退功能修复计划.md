## 问题分析

通过对代码的详细检查，我发现了扫码签到/签退功能失败的根本原因：

1. **二维码格式不匹配**：后端生成的二维码内容是一个完整的URL（如 `http://localhost:3001/api/activities/1/signin?t=1234567890`），但前端和后端的 `/api/user/sign` 接口期望的是 `activity-{id},{action}` 格式（如 `activity-1,signIn`）。

2. **解析逻辑错误**：后端的 `/api/user/sign` 接口尝试从二维码内容中解析活动ID和操作类型，但当它收到URL格式的二维码内容时，解析失败，导致活动ID无效，最终返回 "活动不存在" 的错误。

## 修复方案

### 1. 修改二维码生成逻辑

修改 `backend/routes/activities.js` 中的二维码生成逻辑，使其生成包含活动ID和操作类型的格式，而不是完整的URL。

### 2. 确保前后端数据格式一致

确保前端生成的模拟二维码和后端生成的真实二维码都使用相同的格式：`activity-{id},{action}`。

### 3. 优化错误处理

在后端的 `/api/user/sign` 接口中添加更详细的错误处理，提供更具体的错误提示，帮助调试和用户体验。

## 修复步骤

### 步骤1：修改二维码生成逻辑

1. 打开 `backend/routes/activities.js` 文件
2. 找到 `router.post('/:id/qrcode', ...)` 路由（第1732行）
3. 修改 `signInUrl` 生成逻辑，将其从完整URL改为 `activity-{id},signIn` 格式
4. 同样修改 `router.put('/:id/qrcode', ...)` 路由（第1763行）

### 步骤2：修改活动参与者模型

确保 `ActivityParticipant` 模型包含 `signInTime` 和 `signOutTime` 字段，用于存储签到和签退时间。

### 步骤3：优化错误处理

1. 打开 `backend/routes/user.js` 文件
2. 找到 `router.post('/sign', ...)` 路由（第425行）
3. 添加更详细的错误处理，特别是在解析二维码内容时
4. 提供更具体的错误信息，如 "二维码格式错误"、"操作类型无效" 等

### 步骤4：测试修复效果

1. 重新启动后端服务器
2. 生成新的活动二维码
3. 在前端测试扫码签到/签退功能
4. 验证功能是否正常工作

## 预期结果

修复后，当用户使用正确格式的二维码进行扫码时，系统应该能够：
1. 正确解析二维码内容
2. 找到对应的活动
3. 执行签到或签退操作
4. 返回成功消息

如果二维码格式不正确或活动不存在，系统应该返回具体的错误信息，帮助用户理解问题所在。