## 问题分析

**根本原因**：jsQR库从CDN加载失败，导致扫码功能无法正常工作。

**错误表现**：
1. 浏览器控制台显示"jsQR库加载失败，扫码功能可能无法正常工作"
2. 用户界面显示"二维码识别库加载失败，请刷新页面重试"
3. 扫码功能无法使用

**可能的原因**：
1. CDN连接问题：cdnjs.cloudflare.com可能无法访问
2. 网络环境限制：用户网络可能阻止了CDN资源加载
3. 浏览器安全策略：某些浏览器或安全设置可能阻止跨域脚本加载
4. 库版本问题：可能存在版本兼容性问题

## 修复方案

### 1. 实现多CDN源备选机制
- 添加多个CDN源，当一个CDN失败时自动尝试另一个
- 提高库加载的成功率，增强系统的健壮性

### 2. 提供本地备份方案
- 下载jsQR库到本地项目中
- 当所有CDN源都失败时，使用本地备份
- 确保在离线环境下也能使用扫码功能

### 3. 改进错误处理和用户体验
- 提供更友好的错误提示
- 实现重试机制，允许用户手动重试加载库
- 添加加载状态指示器，让用户了解当前状态

### 4. 优化库加载检查
- 改进检查机制，确保在库完全加载后再进行检查
- 添加超时机制，避免长时间等待

### 5. 添加备选功能
- 实现手动输入二维码内容的功能
- 当扫码功能不可用时，提供备选方案

## 具体代码修改

### 1. 下载jsQR库到本地
- 从cdnjs.cloudflare.com下载jsQR.min.js文件
- 保存到项目的src/js目录下

### 2. 修改index.html，实现多CDN源和本地备份
```html
<!-- 引入jsQR二维码识别库 - 实现多CDN源和本地备份 -->
<script>
    // 动态加载jsQR库，支持多CDN源和本地备份
    (function() {
        // 定义jsQR库的多个加载源，按优先级排序
        const sources = [
            'https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js',
            'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js',
            'https://unpkg.com/jsqr@1.4.0/dist/jsQR.min.js',
            'src/js/jsQR.min.js' // 本地备份
        ];
        
        let currentSourceIndex = 0;
        let loadAttempts = 0;
        const maxAttempts = 5;
        
        // 加载jsQR库的函数
        function loadJSQR() {
            if (currentSourceIndex >= sources.length || loadAttempts >= maxAttempts) {
                // 所有源都加载失败
                console.error('所有jsQR库源都加载失败');
                window.jsQRLoaded = false;
                return;
            }
            
            const script = document.createElement('script');
            const source = sources[currentSourceIndex];
            
            script.src = source;
            script.async = true;
            
            // 加载成功回调
            script.onload = function() {
                console.log('jsQR库加载成功，来源:', source);
                window.jsQRLoaded = typeof jsQR !== 'undefined';
            };
            
            // 加载失败回调
            script.onerror = function() {
                console.error('jsQR库加载失败，来源:', source);
                currentSourceIndex++;
                loadAttempts++;
                loadJSQR(); // 尝试下一个源
            };
            
            // 添加到文档中
            document.head.appendChild(script);
        }
        
        // 开始加载
        loadJSQR();
    })();
    
    // 全局变量跟踪jsQR加载状态
    window.jsQRLoaded = false;
</script>
```

### 3. 修改main.js，改进错误处理和用户体验

#### 3.1 改进startScan函数
```javascript
// 开始扫描
async function startScan() {
    try {
        // 重置UI状态
        scanStatus.textContent = '正在准备扫码...';
        startScanBtn.style.display = 'none';
        stopScanBtn.style.display = 'inline-block';
        
        // 检查jsQR库是否加载完成
        if (typeof jsQR === 'undefined') {
            // 显示加载状态，提供重试选项
            scanStatus.innerHTML = '二维码识别库正在加载... <button id="retryLoadBtn" class="btn btn-sm">重试</button>';
            
            // 添加重试按钮事件
            const retryBtn = document.getElementById('retryLoadBtn');
            if (retryBtn) {
                retryBtn.onclick = function() {
                    // 重新加载jsQR库
                    location.reload();
                };
            }
            
            // 设置5秒后自动重试
            setTimeout(() => {
                if (typeof jsQR === 'undefined') {
                    scanStatus.innerHTML = '二维码识别库加载失败，<br>请检查网络连接或 <button id="retryBtn" class="btn btn-sm">刷新页面</button> <br>或 <button id="manualInputBtn" class="btn btn-sm">手动输入</button>';
                    
                    // 添加刷新按钮事件
                    const refreshBtn = document.getElementById('retryBtn');
                    if (refreshBtn) {
                        refreshBtn.onclick = function() {
                            location.reload();
                        };
                    }
                    
                    // 添加手动输入按钮事件
                    const manualBtn = document.getElementById('manualInputBtn');
                    if (manualBtn) {
                        manualBtn.onclick = function() {
                            showManualQRInput();
                        };
                    }
                    
                    // 恢复UI状态
                    startScanBtn.style.display = 'inline-block';
                    stopScanBtn.style.display = 'none';
                }
            }, 5000);
            
            return;
        }
        
        // 原有扫码逻辑...
    } catch (error) {
        // 原有错误处理...
    }
}
```

#### 3.2 添加手动输入二维码功能
```javascript
// 显示手动输入二维码界面
function showManualQRInput() {
    scanStatus.innerHTML = `
        <div class="manual-input-container">
            <h4>手动输入二维码内容</h4>
            <input type="text" id="manualQRInput" placeholder="请输入二维码内容" style="width: 100%; padding: 8px; margin: 10px 0;">
            <div style="display: flex; gap: 10px;">
                <button id="submitManualQR" class="btn btn-primary">提交</button>
                <button id="cancelManualQR" class="btn btn-secondary">取消</button>
            </div>
        </div>
    `;
    
    // 添加提交按钮事件
    const submitBtn = document.getElementById('submitManualQR');
    if (submitBtn) {
        submitBtn.onclick = function() {
            const qrContent = document.getElementById('manualQRInput').value.trim();
            if (qrContent) {
                handleScanResult(qrContent);
            } else {
                alert('请输入二维码内容');
            }
        };
    }
    
    // 添加取消按钮事件
    const cancelBtn = document.getElementById('cancelManualQR');
    if (cancelBtn) {
        cancelBtn.onclick = function() {
            scanStatus.textContent = '请将二维码对准扫描框';
            startScanBtn.style.display = 'inline-block';
            stopScanBtn.style.display = 'none';
        };
    }
}
```

#### 3.3 改进jsQR库检查机制
```javascript
// 页面完全加载后（包括外部资源），检查jsQR库是否可用
window.addEventListener('load', function() {
    // 延迟检查，确保库有足够时间加载
    setTimeout(() => {
        if (typeof jsQR === 'undefined') {
            console.error('jsQR库加载失败，扫码功能可能无法正常工作');
            window.jsQRLoaded = false;
        } else {
            console.log('jsQR库加载成功，扫码功能可以正常使用');
            window.jsQRLoaded = true;
        }
    }, 1000); // 延迟1秒检查
});
```

### 4. 优化tick函数，确保在库不可用时不会崩溃
```javascript
// 帧检测函数
function tick() {
    try {
        if (!scanning || !video || video.readyState !== video.HAVE_ENOUGH_DATA) {
            requestAnimationFrame(tick);
            return;
        }
        
        // 设置画布大小并绘制视频帧
        canvasElement.width = video.videoWidth;
        canvasElement.height = video.videoHeight;
        canvasContext.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        
        const currentTime = Date.now();
        
        if (currentTime - lastScanTime > SCAN_INTERVAL) {
            // 检查jsQR库是否可用
            if (typeof jsQR === 'undefined') {
                // 库不可用，显示提示信息
                if (scanStatus && scanStatus.textContent !== '二维码识别库加载中...') {
                    scanStatus.innerHTML = '二维码识别库加载中... <button id="retryScanBtn" class="btn btn-sm">重试</button>';
                    
                    // 添加重试按钮事件
                    const retryBtn = document.getElementById('retryScanBtn');
                    if (retryBtn) {
                        retryBtn.onclick = function() {
                            lastScanTime = currentTime; // 立即重试
                        };
                    }
                }
                lastScanTime = currentTime;
                requestAnimationFrame(tick);
                return;
            }
            
            // 原有二维码识别逻辑...
        }
        
        requestAnimationFrame(tick);
    } catch (error) {
        console.error('tick函数执行错误:', error);
        requestAnimationFrame(tick);
    }
}
```

## 修复效果预期

1. **提高库加载成功率**：通过多CDN源和本地备份，大幅提高jsQR库加载成功的概率
2. **改善用户体验**：提供更友好的错误提示和重试选项
3. **增强系统健壮性**：在库加载失败时，系统仍能正常运行，并提供备选方案
4. **提供离线支持**：通过本地备份，在离线环境下也能使用扫码功能
5. **提供备选功能**：实现手动输入二维码功能，确保在极端情况下仍能使用扫码功能

## 测试建议

1. **基本功能测试**：验证扫码功能是否能正常启动和识别二维码
2. **离线测试**：在断网情况下测试本地备份是否能正常工作
3. **CDN故障测试**：模拟CDN故障，验证多CDN源切换是否正常
4. **重试机制测试**：测试重试功能是否能提高成功率
5. **手动输入测试**：验证手动输入二维码功能是否正常工作
6. **兼容性测试**：在不同浏览器和设备上测试

## 技术要点

- 实现动态脚本加载，支持多CDN源和本地备份
- 使用事件监听器处理脚本加载成功和失败情况
- 实现重试机制，提高库加载成功率
- 添加手动输入二维码功能，作为备选方案
- 改进错误处理，提供友好的用户提示
- 优化库加载检查，确保准确性

## 所需资源

1. **jsQR库本地备份**：从https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js下载jsQR.min.js文件，保存到src/js目录下
2. **无需额外依赖**：所有修改基于现有代码，无需添加新的依赖

## 修复风险评估

1. **低风险**：修改主要集中在前端脚本加载和错误处理，不涉及核心业务逻辑
2. **向后兼容**：所有修改都保持了与现有代码的兼容性
3. **易于回滚**：如果出现问题，可以快速恢复到原有代码
4. **性能影响**：修改对性能影响极小，甚至可能提高性能（通过优化库加载）