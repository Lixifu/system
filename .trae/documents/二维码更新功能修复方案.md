## 二维码更新功能修复方案

### 问题分析
经过代码审查，发现点击"更新二维码"按钮后前端页面展示的二维码未发生更新的根本原因是：每次生成的二维码编码的URL相同，导致视觉上完全一致，用户误以为未更新。

### 修复方案

#### 1. 后端二维码生成逻辑优化
**文件路径：** `backend/routes/activities.js`

**修改内容：**
- 在生成签到URL时添加时间戳参数，确保每次生成的URL唯一
- 修改POST和PUT路由中的二维码生成逻辑

**关键代码修改：**
```javascript
// 修改前
const signInUrl = `${req.protocol}://${req.get('host')}/api/activities/${activity.id}/signin`;

// 修改后
const signInUrl = `${req.protocol}://${req.get('host')}/api/activities/${activity.id}/signin?t=${Date.now()}`;
```

#### 2. 前端功能验证与优化

**文件路径：** `src/js/main.js`

**修改内容：**
- 验证更新二维码按钮的事件绑定和响应处理逻辑
- 确保下载功能使用最新的二维码数据
- 添加调试信息，便于跟踪二维码更新流程

### 修复效果预期

1. **视觉变化**：每次点击"更新二维码"按钮后，页面展示的二维码图像会发生明显变化
2. **功能完整性**：
   - 二维码生成功能正常
   - 二维码更新功能正常
   - 二维码下载功能正常
   - 二维码禁用功能正常
3. **数据一致性**：
   - 前端展示的二维码与数据库中的数据一致
   - 下载的二维码为最新版本
   - 活动与二维码的关联关系稳定

### 测试计划

1. **功能测试**：
   - 点击"更新二维码"按钮，确认二维码图像发生变化
   - 点击"下载二维码"按钮，确认下载的是最新二维码
   - 点击"禁用当前二维码"按钮，确认二维码被正确禁用
2. **数据一致性测试**：
   - 检查数据库中活动的qrCode字段是否更新
   - 验证生成的二维码包含正确的活动信息
3. **边界情况测试**：
   - 测试不同有效期和使用次数限制下的二维码生成
   - 测试活动不存在时的错误处理

### 风险评估

1. **风险**：修改后的URL可能影响扫码签到功能
   **缓解措施**：确保签到API能忽略URL中的额外参数
2. **风险**：二维码数据量增大
   **缓解措施**：已将数据库字段类型修改为TEXT，能够处理更大的数据

### 相关文件

1. **后端文件**：
   - `backend/routes/activities.js` - 二维码生成和更新逻辑
   - `backend/models/Activity.js` - 活动模型定义

2. **前端文件**：
   - `src/js/main.js` - 二维码管理功能实现

### 修复优先级

- **紧急**：影响用户正常使用二维码更新功能
- **高风险**：无重大风险，修改范围有限
- **预期修复时间**：30分钟